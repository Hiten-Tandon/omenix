#!/bin/bash
# Omenix Fan Control Helper Script
# This script is used with polkit to manage fan modes

if [ "$#" -ne 1 ]; then
    echo "Usage: $0 <fan_mode>"
    echo "fan_mode: 0 (max) or 2 (bios)"
    exit 1
fi

FAN_MODE="$1"

# Validate fan mode
if [ "$FAN_MODE" != "0" ] && [ "$FAN_MODE" != "2" ]; then
    echo "Error: Invalid fan mode. Use 0 (max) or 2 (bios)"
    exit 1
fi

# Find the fan control path
FAN_PATH=$(find /sys/devices/platform/hp-wmi/hwmon/hwmon*/pwm1_enable 2>/dev/null | head -n1)

if [ -z "$FAN_PATH" ]; then
    echo "Error: Fan control path not found"
    exit 1
fi

# Write the fan mode
echo "$FAN_MODE" > "$FAN_PATH"

if [ $? -eq 0 ]; then
    echo "Successfully set fan mode to $FAN_MODE"
    exit 0
else
    echo "Error: Failed to set fan mode"
    exit 1
fi
